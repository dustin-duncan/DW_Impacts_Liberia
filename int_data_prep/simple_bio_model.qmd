---
title: "SPM_bio_model"
author: "Dustin Duncan"
format: html
editor: visual
---

```{r}
# rm(list=ls())
library(tidyverse)
library(devtools)
# install_github("https://github.com/haddonm/MQMF")
# devtools::install_github("https://github.com/haddonm/MQMF")
library(MQMF)
# library(terra)
# library(tidyterra)
# library(sf)
library(datalimited2)
library(nloptr)
library(deSolve)
# library(rethinking)
```

```{r}
cpue = read.csv(here::here("data_int/data_FAO/cpue_timeseries_1990_2017.csv"))
effort = read.csv(here::here("data_int/data_FAO/effort_timeseries_1990_2017.csv"))
catch = read.csv(here::here("data_int/data_FAO/catch_timeseries_1990_2017.csv"))
catch_nafaa = read.csv(here::here("data_int/data_NaFAA/catch_timeseries_2018_2023.csv"))
all_metrics = read.csv(here::here("data_int/data_FAO/all_metrics_timeseries_1997_2017.csv"))
```

```{r}
library(readr)
SAU_EEZ_430_v50_1 <- read_csv(here::here("data_raw/data_SAU/SAU EEZ 430 v50-1.csv"))
View(SAU_EEZ_430_v50_1)

sardinellas <- SAU_EEZ_430_v50_1 %>% 
  mutate(filters = if_else(str_detect(scientific_name, "Sardinella"), 1, 0)) %>% 
  filter(filters %in% c(1)) %>% 
  filter(year > 2003) %>% 
  filter(gear_type %in% c("small scale seine nets", "subsistence fishing gear", "pelagic trawl", "artisanal fishing gear", "small scale gillnets"))
```

## Quick Plots 

```{r}

dwf = all_metrics %>% 
  filter(Fleet %in% "Industrial") %>% 
  select(Effort, Year)
ggplot(all_metrics, aes(x = Year, y=CPUE, color=Fleet)) + 
  geom_line()
ggplot(dwf, aes(x = Year, y=Effort)) + 
  geom_line()
ggplot(all_metrics, aes(x = Year, y=Catch_tonnes, color=Fleet)) + 
  geom_line()

```

## Using datalimited2 package to estimate range of q values 

```{r}
spmdata = all_metrics %>% 
  group_by(Year) %>% 
  summarize(catch = sum(Catch_tonnes, na.rm = TRUE),
    effort = sum(Effort, na.rm=TRUE)) %>% 
  mutate(cpue = catch/effort) %>%
  rename(year = Year) %>% 
  mutate(year = as.numeric(year),
         catch = as.numeric(catch),
         effort = as.numeric(effort)) %>% 
  filter(!effort == 0) %>% 
  filter(year > 2007) %>% 
  ungroup() %>% 
  as.data.frame()


bsm_out = datalimited2::bsm(year=spmdata$year, 
                            catch=spmdata$catch, 
                            biomass=spmdata$cpue, 
                            btype="CPUE", 
                            r.low=0.35, r.hi=0.55, 
                            stb.low=0.4, stb.hi=0.7)

plot_dlm(bsm_out)
ref_pts = bsm_out[["ref_pts"]]
ref_ts = bsm_out[["ref_ts"]]
```

```{r}
options(scipen=999)
1.22e-06
```


$$
\begin{align}
&\text{Biological Parameters} \\ 
\gamma &= \text{Annual production of juveniles as proportion } \\
&~~~~~~\text{of adult stock biomass } \\ 
\mu &= \text{Zone natural mortality rate } \mathrm{(year^{-1})} \\ 
v &= \text{Proportion of juvenile biomass that} \\
&~~~~~~\text{recruits each year } \mathrm{(year^{-1})} \\ ~ \\
&\text{Economic Parameters} \\
q_{f} &= \text{Catchability coefficient for fleet f}  \\ 
&~~~~~\mathrm{(no~ dimension)} \\
\phi &= \text{Rate of reinvesting in fisheries } \\
&~~~~~\mathrm{(dimensionless)} \\
p &= \text{Fish price } \mathrm{(USD~ton^{-1})} \\
c_{z} &= \text{Cost for SSF effort in zone z} \\
c &= \text{Cost for DWF effort} \\ 
\end{align}
$$



$$
\begin{align}
\frac{dB_{1}}{d \tau} &= -\mu B_{1}-q_{A}B_{1}e_{1}-q_{I}B_{1}E+ vB_{j}(1-{\chi}) \\

\frac{dB_{2}}{d \tau} &=  -\mu B_{2}-q_{A}B_{2}e_{2}+ vB_{j}{\chi} \\

\frac{dB_{3}}{d \tau} &= \gamma(B_{1}+B_{2})-q_{A}B_{3}e_{3}-vB_{3}-\mu B_{3} \\ 
 
\frac{de_{1}}{d \tau} &= e_{1} + \phi[-(c_{1}e_{1})^{2}+pq_{A}B_{1}e_{1}] \\

\frac{de_{2}}{d \tau} &= e_{2} + \phi[-(c_{2}e_{2})^{2}+pq_{A}B_{2}e_{2}] \\
 
\frac{de_{3}}{d \tau} &= e_{3} +  \phi[-(c_{3}e_{3})^{2}+pq_{A}B_{3}e_{3}] \\
 
\frac{dE}{d \tau} &= E + \phi[ -(cE)^{2}+(1-\alpha)pq_{I}B_{1}E] \\

\mathrm{C_{SSF, z,t}} &= q_{SSF}B_{z,t}e_{z,t} \\ 

\mathrm{C_{DWF, t}} &= q_{DWF}B_{1,t}E_{t} \\

\Pi_{SSF,t} &= \sum_{z=1}^{z=3} pC_{SSF,z,t } - c_{z} e_{z,t} \\

\mathrm{ NPV} &= \sum_{t=1}^{t=T} \rho^{t}[\mathrm{\beta\Pi_{SSF,t}+(1-\beta) \alpha p C_{DWF}] }

\end{align}
$$


$$
Y = q*f*B
\\ Y = 5115 \\
f = 158446 \\
B = 22020
$$

## Using SPM function to develop harvest function 

```{r}
# Estimates from FAO: r = 0.45/year, K = 100 000 tonnes, and BI/K = 60 percent, D=40%
catch_nafaa = read.csv(here::here("data_int/data_NaFAA/catch_timeseries_2018_2023.csv")) %>% 
  group_by(Year) %>% 
  summarize(Catch_tonnes = sum(Catch_tonnes)) %>% 
  filter(Year > 2018) %>% 
  rename(year = Year,
         catch = Catch_tonnes) %>% 
  mutate(year = seq(from=1, to= 5, by =1))

## Im going to change the effort functions to be additive, because the new effort is insanely high, then change the fleet dynamics parameter to reflect the rate of entry into the fishery (i.e the effort response is not as large or as immediate)

source("../utils/interaction2.R")
source("../utils/loglikelihood.R")
source("../utils/constraint.R")
source("../utils/plot_fx.R")


state = c(B1i = 9000, B2i = 9000, B3i = 4000,
          e1i = 8000, e2i = 12000, e3i = 1000, Ei = 10000)

newstate = c(B1i = 3638.688, B2i = 10207.942, B3i = 5158.846,
          e1i = 15784.621, e2i = 4307.414, e3i = 1520.177, Ei = 3981.774)

parameters = c(
  # Biological parameters
  mu=0.43, chi=0.5, 
  gamma=0.5, v=1,
  # Economic Parameters
  q1D=0.00000147*2, q1S=0.00000147, q2=0.00000147, q3=0.00000147,
  C1=0.060, C2=0.045, C3=0.040, C=0.045,
  W=0.5, omega=0.005, p=500, discount=0.05)

time = 10

choice=0.1

tester = interaction_LL(choice=0.1, state=log(newstate),time=time, params=log(parameters), rtn_catch = FALSE, rtn_npv=FALSE)

ddplot(tester, bmsy=TRUE)
######################## First test! These are preliminary results for when the fee is 10% of landed value over 10 years, when NaFAA places equal weight on the SSF profit and their revenue from DWF. 
```


```{r}
# pars=log(state)
# params=log(parameters)
# choice = 0.1
# indat=catch_nafaa
# logobs=log(catch_nafaa[, "catch"]$catch)
# funk=interaction_LL

negativeLL(pars=log(newstate), 
      funk=interaction_LL, 
      logobs=log(catch_nafaa[, "catch"]$catch), 
      choice = 0.1,
      indat=catch_nafaa, 
      params=log(parameters),
      time=time)

# This optimization is not working for some reason. Im not sure why but its janked 
scalepar=magnitude(newstate)

bestL <- optim(par = log(newstate),
               fn = negativeLL,
               funk=interaction_LL,
               logobs=log(catch_nafaa[, "catch"]$catch),
               choice=0.1,
               indat=catch_nafaa, 
               params=log(parameters), time=time,
               rtn_catch = TRUE, rtn_npv=FALSE,
               method="Nelder-Mead",
               # lower = log(lower),
               # upper = log(upper),
               # hessian=TRUE,
               control=list(maxit=1000,parscale=scalepar))

options(scipen=999)
exp(bestL$par)
bestL$value
bestL$counts
bestL$convergence
bestL$message

## With the additional effort term (first iteration [incorrect specification but still appears to be the best initial parameter set])
newstate = c(B1i = 3638.688, B2i = 10207.942, B3i = 5158.846,
          e1i = 15784.621, e2i = 4307.414, e3i = 1520.177, Ei = 3981.774)

## Without the additional effort term
newstate = c(B1i = 5695.763, B2i = 8934.127, B3i = 5473.853,
          e1i = 11761.151, e2i = 6378.981, e3i = 1071.943, Ei = 6076.548)

negativeLL(pars=log(newstate), 
      funk=interaction_LL, 
      logobs=log(catch_nafaa[, "catch"]$catch), 
      indat=catch_nafaa, 
      parameters=log(parameters), 
      time=time,rtn_catch=TRUE, rtn_npv=FALSE)

tester = interaction_LL(choice=0.1, state=bestL$par,time=time, params=log(parameters), rtn_catch = TRUE)
tester
log(catch_nafaa[, "catch"]$catch)
```

## New Interaction function

```{r}
# mean_effort = all_metrics %>% filter(Fleet %in% "Artisanal") %>% filter(Year > 2003) %>% summarize(mean_eff = mean(Effort, na.rm=TRUE))
# 
# eff_initial = mean_effort$mean_eff

# These came from bio_parameter_calculation script
# q_dwf = 0.00000269
# q_ssf = 0.000000443
```

```{r}
# Back of the napkin math used to estimate the starting catchability for each fleet. Used the all_metrics dataframe to divide catch by 22020*effort for 2017 (artisanal) and 2007 (industrial)

local_opts<-list("algorithm"="NLOPT_LN_COBYLA",xtol_rel=1e-15)
options=list("algorithm"="NLOPT_LN_AUGLAG",xtol_rel=1e-15,maxeval=160000,"local_opts"=local_opts)

benefits_out=nloptr(x0 = 0.1,
                    eval_f = interaction_LL,
                    opts = options,
                    lb = 0,
                    ub = 1,
                    eval_g_ineq=constraint_fx,
                    state=log(newstate),
                    time=10, 
                    params=log(parameters),
                    rtn_catch=FALSE,
                    rtn_npv=TRUE,
                    indat=NULL
                    )

benefits_out$solution
-benefits_out$objective

tablee = interaction_LL(choice=benefits_out$solution, state=log(newstate), time=10, params=log(parameters), rtn_catch=FALSE, rtn_npv=FALSE)
ddplot(tablee)
```

When running the model under initial parameter values and calibrated initial state values, over a 10-year time period with NaFAA placing equal weight on the profit of small scale fishers and the revenue from DWF, the optimal solution found was to raise the price of the access fee to 100%, leading to a net present value over a 10-year time period of $370,194 USD, in 2023 dollar value. This solution would cause a decline in effort from DWF due to net losses, and eventually lead them to leave the fishery. Compared to the business as usual case, this would (to be continued...)

### Results 

```{r}
############ Trends in output with following parameters: ##############

## choice = 0.5004061
## time = 2 
## state = c(B1i = 9000, B2i = 9000, B3i = 4000,
#           e1i = 8000, e2i = 12000, e3i = 1000, Ei = 10000)

## parameters = c(
#   # Biological parameters
#   gamma=10, v=20, eta=0.013, mu=0.43, chi=0.5,
#   # Economic Parameters
#   q1D=0.0000764, q1S=0.00000147, q2=0.00000147, q3=0.00000147,
#   C1=0.060, C2=0.045, C3=0.040, C=0.045,
#   W=0.75, omega=1, p=500, discount=0.05)

## It appears that the biomass in each zone in time = 2 increases, along with effort in each zone. This tells us the following: The harvest in time 1 is both profitable for all fleets and not enough to diminish biomass significantly. In addition, with the given weighting parameters and incorporating distant water harvest into the NaFAA benefits formula, the optimal solution says that DWF effort will increase a LOT in time two. 

```






